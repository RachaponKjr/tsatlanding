# ---- Build stage ----
FROM node:20-alpine AS builder

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Library ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Build
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Copy dependencies
COPY package.json package-lock.json* pnpm-lock.yaml* ./

# Install Dependencies
RUN npm install

# Copy source code
COPY . .

# --- ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ---
ARG NEXT_PUBLIC_API_URL=/api/landing
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
# ---------------------

# Config ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô RAM ‡∏ï‡∏≠‡∏ô Build
ENV NEXT_TELEMETRY_DISABLED 1
ENV NODE_OPTIONS="--max-old-space-size=1024"

# ‡∏™‡∏±‡πà‡∏á Build
RUN npm run build

# ---- Production stage (Secure Hardened) ----
FROM node:20-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production
# URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Server-side
ENV API_URL=http://tsat-landing-back:3001/api/v1

# ---------------------------------------------------
# üõ°Ô∏è SECURITY HARDENING: ‡∏ï‡∏±‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÇ‡∏à‡∏£‡∏ó‡∏¥‡πâ‡∏á üõ°Ô∏è
# 1. ‡∏•‡∏ö apk (Package Manager) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏ö‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°
# 2. ‡∏•‡∏ö wget ‡πÅ‡∏•‡∏∞ curl ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Script ‡πÑ‡∏ß‡∏£‡∏±‡∏™
# 3. ‡∏•‡∏ö nc (Netcat) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Reverse Shell
# ---------------------------------------------------
RUN apk update && \
    rm -rf /sbin/apk /etc/apk /lib/apk /usr/share/apk /var/lib/apk && \
    rm -rf /usr/bin/wget /usr/bin/curl /usr/bin/nc

# ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Non-root)
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copy ‡πÑ‡∏ü‡∏•‡πå Public
COPY --from=builder /app/public ./public

# Copy ‡πÑ‡∏ü‡∏•‡πå Build (Standalone mode)
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# ‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ User ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
USER nextjs

EXPOSE 3000
ENV PORT=3000

CMD ["node", "server.js"]